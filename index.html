<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RDMex</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸš€</text></svg>">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap:; connect-src 'self' https://api.real-debrid.com https://raw.githubusercontent.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; font-src 'self' https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' 'unsafe-eval';">

    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
    <style>
      .fade-in { animation: fadeIn 0.3s ease-in; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      .toast { position: fixed; top: 20px; right: 20px; z-index: 1000; }
    </style>
</head>
<body class="bg-white min-h-screen">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-800 text-white p-4 shadow-md flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold flex items-center"><i class="fas fa-rocket mr-3"></i>RDMex</h1>
      </div>
      <div class="text-right opacity-90">
        <span id="apiListSize" class="text-xl font-bold"></span>
      </div>
    </div>

    <div class="container mx-auto px-4 md:px-6 py-8 max-w-7xl">
      <!-- Cards -->
      <div class="bg-gray-100 rounded-lg shadow-lg p-6 mb-8">
        <div class="flex flex-col md:flex-row gap-6">
            <div class="flex-1 flex relative h-32 md:h-auto">
                <div id="magnetPlaceholder" class="absolute inset-0 flex items-center justify-center pointer-events-none transition-opacity duration-300">
                    <i class="fas fa-magnet text-4xl text-gray-400"></i>
                </div>
                <textarea id="magnetInput" rows="2" class="w-full h-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-left bg-transparent z-10 md:min-h-[128px]"></textarea>
            </div>
            <div class="flex-1 flex h-32 md:h-auto">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center w-full h-full flex flex-col justify-center items-center relative" id="dropZone">
                    <input type="file" id="torrentFile" accept=".torrent" class="hidden" onchange="displayFileName()" />
                    <div id="dropZoneContent" class="flex flex-col items-center justify-center h-full">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <button onclick="handleUnifiedUpload(this)" id="unifiedUploadButton" class="w-full mt-6 px-4 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center text-2xl">
            <i class="fas fa-upload"></i>
        </button>
        
        <div class="mt-6">
          <div class="flex justify-between items-center mb-1">
            <label for="trackerInput" class="block text-sm font-medium text-gray-700 flex items-center">
                <span class="cursor-pointer" onclick="fetchBestTrackers()">
                    <i class="fas fa-satellite-dish mr-2 text-purple-500"></i>
                </span>
                <span id="trackerStatusIcon" class="ml-2"></span>
                <span id="trackerUpdateTime" class="text-lg font-bold text-gray-700 ml-3"></span>
            </label>
          </div>
          <div class="relative">
            <textarea id="trackerInput" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="ìµœì‹  í†µí•© íŠ¸ë˜ì»¤ ëª©ë¡ì„ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤..."></textarea>
          </div>
        </div>
      </div>

      <div class="bg-gray-100 rounded-lg shadow-lg mb-8 relative" style="height: 600px">
        <div class="absolute top-0 left-0 right-0 p-6 h-20 border-b border-gray-200"><h2 class="text-xl font-semibold flex items-center justify-center text-gray-800 h-full"><i class="fas fa-list mr-2 text-blue-500"></i>í† ë ŒíŠ¸ ëª©ë¡</h2></div>
        <div class="absolute top-20 bottom-20 left-0 right-0 overflow-y-auto p-4"><div id="torrentList" class="space-y-3"><p class="text-gray-500 text-center py-8">í† ë ŒíŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p></div></div>
        <div class="absolute bottom-0 left-0 right-0 p-6 h-20 border-t border-gray-200">
            <div class="flex justify-center items-center h-full gap-4">
                <button onclick="refreshTorrents()" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700"><i class="fas fa-sync-alt mr-2"></i>ìƒˆë¡œê³ ì¹¨</button>
                <button onclick="deleteCompleted()" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700"><i class="fas fa-trash mr-2"></i>ì™„ë£Œì‚­ì œ</button>
            </div>
        </div>
      </div>
      
      <div class="bg-gray-100 rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-semibold mb-4 flex items-center text-gray-800"><i class="fas fa-info-circle mr-2 text-blue-500"></i>ìƒíƒœ ë° ë¡œê·¸</h2>
        <div id="statusLog" class="bg-white rounded-lg p-4 max-h-60 overflow-y-auto"><p id="initialLogMessage" class="text-gray-500">ì¤€ë¹„ ì™„ë£Œ.</p></div>
      </div>
      
      <div class="bg-gray-100 rounded-lg shadow-lg p-6 mt-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold flex items-center text-gray-800">
                <i class="fas fa-key mr-2 text-yellow-500"></i><span class="text-black">API</span>
                <span id="apiCombinedStatus" class="ml-3 text-xl"></span>
            </h2>
        </div>
        <input type="text" id="apiToken" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Real-Debrid API í† í°ì„ ì…ë ¥í•˜ì„¸ìš”" />
        <p class="text-xs text-gray-500 mt-2">
          API í† í°ì€ <a href="https://real-debrid.com/apitoken" target="_blank" class="text-blue-600 underline">real-debrid.com/apitoken</a> ì—ì„œ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br/>
          <span class="text-red-500">ì—°ê²° ì‹¤íŒ¨ ì‹œ:</span> í† í°ì´ ì •í™•í•œì§€, ì¸í„°ë„· ì—°ê²°, ë¸Œë¼ìš°ì € í™•ì¥ í”„ë¡œê·¸ë¨(ê´‘ê³  ì°¨ë‹¨ ë“±)ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
        </p>
        <div class="flex gap-4 mt-4">
          <button onclick="saveToken()" class="flex-1 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700"><i class="fas fa-save mr-2"></i>ì €ì¥</button>
          <button onclick="testConnection()" class="flex-1 px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700"><i class="fas fa-plug mr-2"></i>ì—°ê²° í…ŒìŠ¤íŠ¸</button>
        </div>
      </div>
    </div>
    
    <div id="toastContainer" class="toast"></div>
    <script src="cordova.js"></script>
    <script>
        const API_BASE = "https://api.real-debrid.com/rest/1.0";
        let refreshTimer = null;
        let fastRefreshCount = 0;
        let slowRefreshCount = 0;

        function scheduledRefresh() { if (fastRefreshCount > 0) { addLog(`[ìë™ ê°±ì‹ ] 1ë¶„ ê°„ê²©ìœ¼ë¡œ ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤. (ë‚¨ì€ íšŸìˆ˜: ${fastRefreshCount - 1}íšŒ)`); refreshTorrents(); fastRefreshCount--; if (fastRefreshCount === 0) { addLog("ë¹ ë¥¸ ê°±ì‹ ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. 5ë¶„ ê°„ê²© ê°±ì‹ ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤."); clearInterval(refreshTimer); if (slowRefreshCount > 0) { refreshTimer = setInterval(scheduledRefresh, 300000); } } } else if (slowRefreshCount > 0) { addLog(`[ìë™ ê°±ì‹ ] 5ë¶„ ê°„ê²©ìœ¼ë¡œ ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤. (ë‚¨ì€ íšŸìˆ˜: ${slowRefreshCount - 1}íšŒ)`); refreshTorrents(); slowRefreshCount--; if (slowRefreshCount === 0) { addLog("ìë™ ê°±ì‹  ì£¼ê¸°ê°€ ëª¨ë‘ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”."); clearInterval(refreshTimer); refreshTimer = null; } } else { if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; } } }
        function startOrResetRefreshCycle() { if (refreshTimer) clearInterval(refreshTimer); addLog("ìë™ ê°±ì‹  ì£¼ê¸°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. (5ë¶„ê°„ 1ë¶„ ê°„ê²©, ì´í›„ 55ë¶„ê°„ 5ë¶„ ê°„ê²©)"); fastRefreshCount = 5; slowRefreshCount = 11; scheduledRefresh(); refreshTimer = setInterval(scheduledRefresh, 60000); }
        
        async function fetchBestTrackers() {
            const trackerInput = document.getElementById("trackerInput");
            const statusIcon = document.getElementById("trackerStatusIcon");
            const updateTimeEl = document.getElementById("trackerUpdateTime");
            const curatedTrackers = [ 'udp://tracker.opentrackr.org:1337/announce', 'udp://open.stealth.si:80/announce', 'udp://exodus.desync.com:6969/announce', 'udp://tracker.torrent.eu.org:451/announce', 'udp://tracker.cyberia.is:6969/announce', 'udp://tracker.openbittorrent.com:80/announce', 'udp://tracker.zer0day.to:1337/announce', 'udp://p4p.arenabg.com:1337/announce', 'udp://tracker.leechers-paradise.org:6969/announce', 'udp://9.rarbg.to:2710/announce', 'http://open.tracker.cl:1337/announce', 'udp://open.demonii.com:1337/announce', 'udp://explodie.org:6969/announce', 'udp://public.tracker.vraphim.com:6969/announce', 'udp://tracker.dler.org:6969/announce' ];
            const externalTrackerUrls = [ 'https://raw.githubusercontent.com/ngosang/trackerslist/master/trackers_best.txt', 'https://raw.githubusercontent.com/ngosang/trackerslist/master/trackers_all_ip.txt' ];
            statusIcon.innerHTML = '<i class="fas fa-spinner loading text-purple-500"></i>';
            addLog(`ìµœì‹  í†µí•© íŠ¸ë˜ì»¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤...`);
            try {
                const responses = await Promise.all(externalTrackerUrls.map(url => fetch(url)));
                for (const response of responses) { if (!response.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status} for ${response.url}`); }
                const externalTexts = await Promise.all(responses.map(res => res.text()));
                const combinedTrackers = curatedTrackers.concat(externalTexts.join('\n').split('\n'));
                const uniqueTrackers = [...new Set(combinedTrackers.map(l => l.trim()).filter(Boolean))];
                if (uniqueTrackers.length > 0) {
                    trackerInput.value = uniqueTrackers.join('\n');
                    statusIcon.innerHTML = '<i class="fas fa-check-circle text-green-500" title="ìµœì‹  íŠ¸ë˜ì»¤ ë¡œë”© ì™„ë£Œ"></i>';
                    const message = `í†µí•©ëœ ê³ ìœ  íŠ¸ë˜ì»¤ ${uniqueTrackers.length}ê°œë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`;
                    showToast(message, 'success');
                    const now = new Date();
                    const formattedTime = now.toLocaleString('ko-KR', { year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    updateTimeEl.innerHTML = `${uniqueTrackers.length}ê°œ<br class="md:hidden"> ${formattedTime}`;
                } else { throw new Error('ë¶ˆëŸ¬ì˜¨ íŠ¸ë˜ì»¤ ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.'); }
            } catch (error) {
                statusIcon.innerHTML = '<i class="fas fa-times-circle text-red-500" title="íŠ¸ë˜ì»¤ ë¡œë”© ì‹¤íŒ¨"></i>';
                const errorMessage = `íŠ¸ë˜ì»¤ ë¡œë”© ì‹¤íŒ¨: ${error.message}`;
                addLog(errorMessage, 'error');
                showToast(errorMessage, 'error');
                updateTimeEl.textContent = 'ì—…ë°ì´íŠ¸ ì‹¤íŒ¨';
            }
        }
        
        async function handleUnifiedUpload(button) { const magnetInput = document.getElementById("magnetInput"); const fileInput = document.getElementById("torrentFile"); const trackerInput = document.getElementById("trackerInput"); const magnetsRaw = magnetInput.value.trim().split('\n'); const magnets = magnetsRaw.map(link => { const match = link.trim().match(/(magnet:\?xt=urn:btih:[a-zA-Z0-9]{40})/); return match ? match[1] : null; }).filter(Boolean); const fileToUpload = fileInput.files[0]; const trackers = trackerInput.value.trim().split("\n").filter(Boolean); if (magnets.length === 0 && !fileToUpload) { showToast("ì¶”ê°€í•  ìœ íš¨í•œ ë§ˆê·¸ë„· ë§í¬ë‚˜ í† ë ŒíŠ¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.", "warning"); addLog("ìœ íš¨í•œ ë§ˆê·¸ë„·ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. magnet:?xt=urn:btih: í˜•ì‹ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.", "warning"); return; } setLoading(button, true); let successCount = 0; let errorCount = 0; addLog(`ì´ ${magnets.length}ê°œì˜ ë§ˆê·¸ë„·ê³¼ ${fileToUpload ? 1 : 0}ê°œì˜ íŒŒì¼ ì²˜ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.`); try { if (magnets.length > 0) { const trackerString = trackers.map((tr) => `&tr=${encodeURIComponent(tr.trim())}`).join(""); if (trackerString) addLog(`${trackers.length}ê°œì˜ íŠ¸ë˜ì»¤ë¥¼ ê° ë§ˆê·¸ë„·ì— ì¶”ê°€í•©ë‹ˆë‹¤.`); for (const [index, magnet] of magnets.entries()) { addLog(`[${index + 1}/${magnets.length}] ë§ˆê·¸ë„· ì¶”ê°€ ì‹œë„ ì¤‘...`); try { const finalMagnet = magnet + trackerString; const response = await makeApiCall("/torrents/addMagnet", { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: `magnet=${encodeURIComponent(finalMagnet)}` }); if (response && response.id) { addLog(`[${index + 1}/${magnets.length}] ID ${response.id} ì¶”ê°€ ì„±ê³µ. íŒŒì¼ ì„ íƒì„ ì‹œì‘í•©ë‹ˆë‹¤.`); await makeApiCall(`/torrents/selectFiles/${response.id}`, { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: "files=all" }); addLog(`[${index + 1}/${magnets.length}] ID ${response.id} íŒŒì¼ ì„ íƒ ì™„ë£Œ. ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤.`, "success"); successCount++; } else { throw new Error("API ì‘ë‹µì—ì„œ í† ë ŒíŠ¸ IDë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); } } catch (e) { errorCount++; addLog(`[${index + 1}/${magnets.length}] ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}`, "error"); } } } if (fileToUpload) { addLog(`í† ë ŒíŠ¸ íŒŒì¼(${fileToUpload.name}) ì¶”ê°€ ì‹œë„ ì¤‘...`); try { const response = await makeApiCall("/torrents/addTorrent", { method: "PUT", body: fileToUpload }); if (response && response.id) { addLog(`íŒŒì¼ ì¶”ê°€ ì„±ê³µ. ID ${response.id} íŒŒì¼ ì„ íƒì„ ì‹œì‘í•©ë‹ˆë‹¤.`); await makeApiCall(`/torrents/selectFiles/${response.id}`, { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: "files=all" }); addLog(`ID ${response.id} íŒŒì¼ ì„ íƒ ì™„ë£Œ. ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤.`, "success"); successCount++; } else { throw new Error("API ì‘ë‹µì—ì„œ í† ë ŒíŠ¸ IDë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); } } catch (e) { errorCount++; addLog(`í† ë ŒíŠ¸ íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}`, "error"); } } if (successCount > 0) showToast(`ì´ ${successCount}ê°œ í•­ëª©ì˜ ë‹¤ìš´ë¡œë“œë¥¼ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.`, "success"); if (errorCount > 0) showToast(`${errorCount}ê°œ í•­ëª© ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.`, "error"); magnetInput.value = ""; fileInput.value = ""; document.getElementById('magnetPlaceholder').classList.remove('opacity-0'); displayFileName(); setTimeout(() => startOrResetRefreshCycle(), 1500); } catch (error) { showToast(`ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, "error"); } finally { setLoading(button, false); } }
        async function refreshTorrents(){ try{ addLog("í† ë ŒíŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."); const torrents = await makeApiCall("/torrents?limit=1000"); const totalBytes = torrents.reduce((sum, torrent) => sum + torrent.bytes, 0); document.getElementById('apiListSize').innerHTML = `ğŸ“š ${formatSize(totalBytes)}`; displayTorrents(torrents); } catch(e) { showToast("í† ë ŒíŠ¸ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: "+e.message,"error"); document.getElementById("torrentList").innerHTML=`<p class="text-red-500 text-center py-8">${e.message}</p>`; } }
        function displayTorrents(torrents) { const listEl = document.getElementById("torrentList"); if (torrents && torrents.length > 0) { listEl.innerHTML = torrents.map(t => ` <div class="border-b border-gray-200 p-3 hover:bg-gray-200 transition duration-200"> <div class="flex justify-between items-start mb-2"> <h3 class="font-semibold text-gray-800 flex-1 mr-4 overflow-hidden text-ellipsis whitespace-nowrap min-w-0" title="${t.filename}">${t.filename || "Unknown"}</h3> <span class="px-2 py-1 rounded text-xs font-medium whitespace-nowrap ${getStatusClass(t.status)}">${getStatusText(t.status)}</span> </div> <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm text-gray-600 mb-3"> <div><i class="fas fa-hdd mr-1 text-gray-400"></i> ${formatSize(t.bytes)}</div> <div><i class="fas fa-arrow-down mr-1 text-green-500"></i> ${formatSize(t.speed || 0)}/s</div> <div><i class="fas fa-clock mr-1 text-gray-400"></i> ${new Date(t.added).toLocaleString()}</div> </div> ${t.progress >= 0 ? `<div class="w-full bg-gray-300 rounded-full h-2.5 mb-3"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${t.progress}%"></div></div>` : ""} <div class="flex justify-between items-center"> <div class="flex gap-2 flex-wrap"> <button onclick="deleteTorrent('${t.id}')" class="px-3 py-1 bg-red-600 text-white text-xs font-semibold rounded hover:bg-red-700"><i class="fas fa-trash mr-1"></i>ì‚­ì œ</button> ${t.status === "waiting_files_selection" ? `<button onclick="selectFiles('${t.id}')" class="px-3 py-1 bg-blue-600 text-white text-xs font-semibold rounded hover:bg-blue-700"><i class="fas fa-check-square mr-1"></i>íŒŒì¼ ì„ íƒ</button>` : ""} </div> <div> ${t.status === "downloaded" ? `<button onclick="getTorrentInfo('${t.id}', this)" class="px-3 py-1 bg-green-600 text-white text-xs font-semibold rounded hover:bg-green-700"><i class="fas fa-download mr-1"></i>ë‹¤ìš´ë¡œë“œ ë§í¬ ë³´ê¸°</button>` : ""} </div> </div> </div>`).join(""); } else { listEl.innerHTML = '<p class="text-gray-500 text-center py-8">í™œì„± í† ë ŒíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; } }
        function getStatusClass(status) { return { waiting_files_selection: "bg-yellow-100 text-yellow-800", queued: "bg-gray-200 text-gray-800", downloading: "bg-blue-100 text-blue-800", downloaded: "bg-green-100 text-green-800", error: "bg-red-100 text-red-800", dead: "bg-red-200 text-red-900" }[status] || "bg-gray-100 text-gray-800"; }
        function getStatusText(status) { return { waiting_files_selection: "íŒŒì¼ ì„ íƒ ëŒ€ê¸°", queued: "ëŒ€ê¸° ì¤‘", downloading: "ë‹¤ìš´ë¡œë“œ ì¤‘", downloaded: "ì™„ë£Œ", error: "ì˜¤ë¥˜", dead: "ë°ë“œ í† ë ŒíŠ¸" }[status] || status; }
        function formatSize(bytes) { if (bytes === 0) return "0 B"; const k = 1024; const sizes = ["B", "KB", "MB", "GB", "TB"]; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i]; }
        async function deleteTorrent(id) { if (!confirm("ì´ í† ë ŒíŠ¸ë¥¼ ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; try { await makeApiCall(`/torrents/delete/${id}`, { method: "DELETE" }); showToast("í† ë ŒíŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤", "success"); await refreshTorrents(); } catch (e) { showToast("ì‚­ì œ ì‹¤íŒ¨: " + e.message, "error"); } }
        async function deleteCompleted() { if (!confirm("ì™„ë£Œëœ ëª¨ë“  í† ë ŒíŠ¸ë¥¼ ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; addLog("ì™„ë£Œëœ í† ë ŒíŠ¸ ì‚­ì œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."); try { const torrents = await makeApiCall("/torrents?limit=1000"); const completed = torrents.filter(t => t.status === 'downloaded'); if (completed.length === 0) { showToast("ì‚­ì œí•  ì™„ë£Œëœ í† ë ŒíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.", "info"); addLog("ì‚­ì œí•  ì™„ë£Œëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤."); return; } let deletedCount = 0; for (const torrent of completed) { await makeApiCall(`/torrents/delete/${torrent.id}`, { method: "DELETE" }); deletedCount++; } showToast(`${deletedCount}ê°œì˜ ì™„ë£Œëœ í† ë ŒíŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, "success"); addLog(`${deletedCount}ê°œì˜ ì™„ë£Œëœ í† ë ŒíŠ¸ë¥¼ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.`, "success"); await refreshTorrents(); } catch (error) { showToast("ì™„ë£Œëœ í† ë ŒíŠ¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.", "error"); addLog(`ì™„ë£Œëœ í•­ëª© ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, "error"); } }
        async function selectFiles(id) { try { addLog(`ID ${id}: ëª¨ë“  íŒŒì¼ì„ ì„ íƒí•©ë‹ˆë‹¤.`); await makeApiCall(`/torrents/selectFiles/${id}`, { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: "files=all" }); showToast("ëª¨ë“  íŒŒì¼ì´ ì„ íƒë˜ì–´ ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤.", "success"); await refreshTorrents(); } catch (e) { showToast("íŒŒì¼ ì„ íƒ ì‹¤íŒ¨: " + e.message, "error"); } }
        
        /**
         * [ìµœì¢… ì™„ì„± ë²„ì „]
         * ì €ìš©ëŸ‰ íŒŒì¼ í•„í„°ë§ ê¸°ëŠ¥ì´ ì¶”ê°€ëœ ìµœì¢… ì½”ë“œì…ë‹ˆë‹¤.
         * 1GB ë¯¸ë§Œì˜ íŒŒì¼ì€ API í˜¸ì¶œ ì „ì— ë¯¸ë¦¬ ì œì™¸í•˜ì—¬ ì†ë„ì™€ íš¨ìœ¨ì„±ì„ ë†’ì˜€ìŠµë‹ˆë‹¤.
         */
        async function getTorrentInfo(torrentId, button) {
            // ì´ ê°’ì„ ìˆ˜ì •í•˜ì—¬ í•„í„°ë§í•  ìµœì†Œ íŒŒì¼ í¬ê¸°ë¥¼ ì¡°ì ˆí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ë‹¨ìœ„: Bytes)
            const MIN_FILE_SIZE_BYTES = 1024 * 1024 * 1024; // 1 GB

            setLoading(button, true);
            showToast("ë‹¤ìš´ë¡œë“œ ë§í¬ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...", "info");
            try {
                addLog(`ID ${torrentId}: 1ë‹¨ê³„ - íŒŒì¼ ì •ë³´ ë° ë¹„ê³µê°œ ë§í¬ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.`);
                const info = await makeApiCall(`/torrents/info/${torrentId}`);

                if (info && info.links && info.links.length > 0 && info.files) {
                    
                    // íŒŒì¼ ì •ë³´ì™€ ë¹„ê³µê°œ ë§í¬ ì •ë³´ë¥¼ ë¨¼ì € í•©ì¹©ë‹ˆë‹¤.
                    const originalFiles = info.files.map((file, index) => ({
                        ...file,
                        privateLink: info.links[index]
                    }));

                    // [í•µì‹¬ ê¸°ëŠ¥] ì €ìš©ëŸ‰ íŒŒì¼ì„ ë¯¸ë¦¬ í•„í„°ë§í•©ë‹ˆë‹¤.
                    const filesToProcess = originalFiles.filter(file => file.bytes >= MIN_FILE_SIZE_BYTES);
                    const hiddenFilesCount = originalFiles.length - filesToProcess.length;

                    if (filesToProcess.length === 0) {
                        throw new Error(`ëª¨ë“  íŒŒì¼ì´ ${formatSize(MIN_FILE_SIZE_BYTES)} ë¯¸ë§Œì´ë¼ ì²˜ë¦¬í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.`);
                    }

                    addLog(`ID ${torrentId}: 2ë‹¨ê³„ - ${filesToProcess.length}ê°œì˜ ìœ íš¨í•œ íŒŒì¼ì„ ìˆœì°¨ì ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤... (${hiddenFilesCount}ê°œ ìˆ¨ê¹€)`);
                    
                    const filesWithRealLinks = [];
                    let successfulLinksCount = 0;

                    for (const file of filesToProcess) {
                        try {
                            const result = await makeApiCall('/unrestrict/link', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                body: `link=${encodeURIComponent(file.privateLink)}`
                            });

                            if (result && result.download) {
                                filesWithRealLinks.push({ ...file, link: result.download });
                                successfulLinksCount++;
                            } else {
                                throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ì‘ë‹µ');
                            }
                        } catch (err) {
                            addLog(`'${file.path}' ë§í¬ ë³€í™˜ ì‹¤íŒ¨: ${err.message}`, 'warning');
                            filesWithRealLinks.push({ ...file, link: null });
                        }
                    }

                    if (successfulLinksCount === 0) {
                        throw new Error("ëª¨ë“  ìœ íš¨ íŒŒì¼ì˜ ë§í¬ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë§í¬ê°€ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì¼ì‹œì ì¸ ì„œë²„ ì˜¤ë¥˜ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                    }

                    const realDownloadLinks = filesWithRealLinks.filter(f => f.link).map(f => f.link);

                    const fileListHTML = filesWithRealLinks.map((file, index) => {
                        const liClass = file.link ? "" : "failed-item";
                        if (file.link) {
                            return `
                                <li class="p-2 my-1 border border-gray-200 rounded-md flex justify-between items-center text-sm hover:bg-gray-50 transition-colors ${liClass}">
                                    <span class="flex-1 mr-2 break-all text-gray-800">
                                        <i class="fas fa-file-alt mr-2 text-gray-500"></i>
                                        ${file.path} <span class="text-gray-500">(${formatSize(file.bytes)})</span>
                                    </span>
                                    <div class="flex-shrink-0 flex items-center gap-2">
                                        <button onclick="navigator.clipboard.writeText('${file.link}'); showToast('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');" class="px-2 py-1 text-gray-600 hover:text-blue-600" title="ë§í¬ ë³µì‚¬">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                        <a href="${file.link}" target="_blank" class="px-3 py-1 bg-green-600 text-white text-xs font-semibold rounded-lg hover:bg-green-700 whitespace-nowrap">
                                            <i class="fas fa-download mr-1"></i>ë‹¤ìš´ë¡œë“œ
                                        </a>
                                    </div>
                                </li>
                            `;
                        } else {
                            return `
                                <li class="p-2 my-1 border border-gray-200 rounded-md flex justify-between items-center text-sm bg-red-50 ${liClass}">
                                    <span class="flex-1 mr-4 break-all text-red-700">
                                        <i class="fas fa-times-circle mr-2 text-red-500"></i>
                                        ${file.path} <span class="text-red-500">(${formatSize(file.bytes)})</span>
                                    </span>
                                    <span class="px-3 py-1 bg-red-600 text-white text-xs font-semibold rounded-lg cursor-not-allowed">
                                        ìƒì„± ì‹¤íŒ¨
                                    </span>
                                </li>
                            `;
                        }
                    }).join('');

                    const modalHTML = `
                        <div id="nativeDownloaderModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 fade-in" onclick="this.remove()">
                            <div class="bg-white rounded-lg shadow-2xl p-6 max-w-4xl w-full max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
                                <div class="flex justify-between items-center mb-4 border-b border-gray-200 pb-3">
                                    <h3 class="text-xl font-semibold text-gray-800 flex-shrink-1 mr-4 overflow-hidden text-ellipsis whitespace-nowrap" title="${info.filename}">${info.filename}</h3>
                                    <button onclick="document.getElementById('nativeDownloaderModal').remove()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                                </div>
                                <div id="file-list-container" class="overflow-y-auto flex-grow pr-2">
                                    ${hiddenFilesCount > 0 ? `<p class="text-sm text-gray-600 mb-3 p-2 bg-gray-100 rounded-md text-center"><i class="fas fa-info-circle mr-2 text-gray-500"></i>${hiddenFilesCount}ê°œì˜ ì €ìš©ëŸ‰ íŒŒì¼(${formatSize(MIN_FILE_SIZE_BYTES)} ë¯¸ë§Œ)ì´ ëª©ë¡ì—ì„œ ìë™ìœ¼ë¡œ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.</p>` : ''}
                                    <ul class="space-y-1">${fileListHTML}</ul>
                                </div>
                                <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between items-center gap-3">
                                     <button onclick="window.open('https://real-debrid.com/downloads', '_blank')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        <i class="fas fa-external-link-alt mr-2"></i>RD í˜ì´ì§€
                                    </button>
                                    <div class="flex gap-3">
                                        <button ${realDownloadLinks.length === 0 ? 'disabled' : ''} onclick="navigator.clipboard.writeText('${realDownloadLinks.join('\\n')}'); showToast('ì„±ê³µí•œ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                            <i class="fas fa-copy mr-2"></i>ëª¨ë‘ ë³µì‚¬
                                        </button>
                                        <button onclick="document.getElementById('nativeDownloaderModal').remove()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">ë‹«ê¸°</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                    addLog(`ID ${torrentId}: 3ë‹¨ê³„ - ë‹¤ìš´ë¡œë” íŒì—…ì„ í‘œì‹œí–ˆìŠµë‹ˆë‹¤. (ì„±ê³µ: ${successfulLinksCount}/${filesToProcess.length})`);
                    showToast("ë§í¬ ìƒì„± ì™„ë£Œ!", "success");

                } else {
                    showToast("ë‹¤ìš´ë¡œë“œ íŒŒì¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "warning");
                    addLog(`ID ${torrentId}: ë‹¤ìš´ë¡œë“œ íŒŒì¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, "warning");
                }
            } catch (error) {
                showToast("ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
                addLog(`ë§í¬ ìƒì„± ì‹¤íŒ¨ (ID: ${torrentId}): ${error.message}`, 'error');
            } finally {
                setLoading(button, false);
            }
        }

        async function makeApiCall(t,e={}){const n=getToken();if(!n)throw new Error("API í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");const o=`${API_BASE}${t}`,s={...e,headers:{Authorization:`Bearer ${n}`,...(e.headers||{})}};try{const i=await fetch(o,s);if(i.status===204)return null;const a=await i.json();if(!i.ok){const r=a&&a.error?`${a.error_code} - ${a.error}`:i.statusText;throw new Error(`API ì˜¤ë¥˜: ${i.status} - ${r}`)}return a}catch(c){throw addLog(`API í˜¸ì¶œ ì‹¤íŒ¨: ${c.message}`,"error"),c}}
        function getToken(){return localStorage.getItem("rdToken")}
        function saveToken(){ const token = document.getElementById("apiToken").value.trim(); if(token) { localStorage.setItem("rdToken", token); showToast("API í† í°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤", "success"); testConnection(); } else { showToast("í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”", "warning"); } }

        async function testConnection() {
            const apiCombinedStatusEl = document.getElementById('apiCombinedStatus');
            apiCombinedStatusEl.innerHTML = `<span class="font-bold text-yellow-500">í™•ì¸ ì¤‘...</span>`;
            try {
                addLog("API ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤...");
                const user = await makeApiCall("/user");
                showToast(`ì—°ê²° ì„±ê³µ! ì‚¬ìš©ì: ${user.username}`, "success");
                addLog(`API ì—°ê²° ì„±ê³µ - ì‚¬ìš©ì: ${user.username}`, "success");
                if (user.type === 'premium' && user.expiration) {
                    const expirationDate = new Date(user.expiration);
                    const now = new Date();
                    const diffDays = Math.ceil((expirationDate - now) / (1000 * 60 * 60 * 24));
                    const formattedExpiration = expirationDate.toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false });
                    let dDayText = `D-${diffDays}`;
                    let colorClass = 'text-green-600';
                    if (diffDays <= 0) { dDayText = 'ë§Œë£Œ'; colorClass = 'text-red-600'; } 
                    else if (diffDays <= 7) { colorClass = 'text-yellow-600'; showToast(`í”„ë¦¬ë¯¸ì—„ ë§Œë£Œì¼ì´ ${diffDays}ì¼ ë‚¨ì•˜ìŠµë‹ˆë‹¤.`, 'warning'); }
                    apiCombinedStatusEl.innerHTML = `<span class="font-semibold ${colorClass}">${formattedExpiration} (<span class="font-black">${dDayText}</span>)</span>, <span class="font-bold text-blue-600">${user.points}P</span>`;
                } else { apiCombinedStatusEl.innerHTML = `<span class="font-bold text-red-600">í”„ë¦¬ë¯¸ì—„ ì•„ë‹˜</span>`; }
            } catch (e) {
                showToast(`ì—°ê²° ì‹¤íŒ¨: ${e.message}`, "error");
                apiCombinedStatusEl.innerHTML = `<span class="font-bold text-red-500" title="${e.message}">ì—°ê²° ì‹¤íŒ¨</span>`;
            }
        }
        
        function addLog(message, type = "info") { const logEl = document.getElementById("statusLog"); const time = new Date().toLocaleTimeString(); const iconClass = type === "error" ? "fa-times-circle text-red-500" : type === "success" ? "fa-check-circle text-green-500" : type === "warning" ? "fa-exclamation-triangle text-yellow-500" : "fa-info-circle text-blue-500"; const initialMsg = document.getElementById("initialLogMessage"); if (initialMsg) initialMsg.remove(); const entry = document.createElement("div"); entry.className = `mb-2 p-2 border-l-4 ${type === "error" ? "border-red-400 bg-red-50" : type === "success" ? "border-green-400 bg-green-50" : type === "warning" ? "border-yellow-400 bg-yellow-50" : "border-blue-400 bg-blue-50"}`; entry.innerHTML = `<span class="text-xs text-gray-500">[${time}]</span> <i class="fas ${iconClass} ml-2 mr-2"></i> <span>${message}</span>`; logEl.appendChild(entry); logEl.scrollTop = logEl.scrollHeight; }
        function showToast(message, type = "info") { const container = document.getElementById("toastContainer"); const toast = document.createElement("div"); const iconClass = type === "success" ? "fa-check-circle" : type === "error" ? "fa-exclamation-circle" : type === "warning" ? "fa-exclamation-triangle" : "fa-info-circle"; const bgColor = type === "success" ? "bg-green-500" : type === "error" ? "bg-red-600" : type === "warning" ? "bg-yellow-500" : "bg-blue-500"; toast.className = `fade-in px-6 py-4 rounded-lg text-white mb-4 shadow-lg ${bgColor}`; toast.innerHTML = `<div class="flex items-center"><i class="fas ${iconClass} mr-3"></i><span class="font-semibold">${message}</span></div>`; container.appendChild(toast); setTimeout(() => { toast.style.opacity = "0"; setTimeout(() => toast.remove(), 300); }, 5000); }
        function setLoading(button, isLoading) {
            if (!button) return;
            if (isLoading) {
                button.disabled = true;
                button.classList.add("opacity-75", "cursor-not-allowed");
                button.innerHTML = `<i class="fas fa-spinner fa-spin mr-1"></i>ìƒì„± ì¤‘...`;
            } else {
                button.disabled = false;
                button.classList.remove("opacity-75", "cursor-not-allowed");
                button.innerHTML = `<i class="fas fa-download mr-1"></i>ë‹¤ìš´ë¡œë“œ ë§í¬ ë³´ê¸°`;
            }
        }
        
        function displayFileName() {
            const fileInput = document.getElementById("torrentFile");
            const dropZoneContent = document.getElementById("dropZoneContent");
            if (fileInput.files.length > 0) {
                dropZoneContent.innerHTML = `<div class="text-center"><i class="fas fa-check-circle text-green-500 mr-2"></i> <strong>${fileInput.files[0].name}</strong> (${formatSize(fileInput.files[0].size)})</div>`;
            } else {
                dropZoneContent.innerHTML = `<i class="fas fa-cloud-upload-alt text-4xl text-gray-400"></i>`;
            }
        }
        
        function initializeApp(){
            const savedToken = localStorage.getItem("rdToken") || "";
            document.getElementById("apiToken").value = savedToken;
            addLog("í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
            if (savedToken) { 
                testConnection();
            } else { 
                addLog("API í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í† í°ì„ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.", "warning");
                const apiCombinedStatusEl = document.getElementById('apiCombinedStatus');
                apiCombinedStatusEl.innerHTML = `<span class="font-bold text-gray-500">í† í° ì—†ìŒ</span>`;
                document.getElementById('apiListSize').textContent = '';
            }
            fetchBestTrackers();
            startOrResetRefreshCycle();
            const dropZone = document.getElementById("dropZone");
            dropZone.addEventListener("click", () => document.getElementById("torrentFile").click());
            ["dragover", "dragleave", "drop"].forEach(eventName => { dropZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }); });
            ["dragenter", "dragover"].forEach(eventName => { dropZone.addEventListener(eventName, () => { dropZone.classList.add("border-blue-400", "bg-blue-50"); }); });
            ["dragleave", "drop"].forEach(eventName => { dropZone.addEventListener(eventName, () => { dropZone.classList.remove("border-blue-400", "bg-blue-50"); }); });
            dropZone.addEventListener("drop", event => { const files = event.dataTransfer.files; if (files.length > 0 && files[0].name.endsWith(".torrent")) { document.getElementById("torrentFile").files = files; displayFileName(); } else { showToast("ìœ íš¨í•œ .torrent íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤", "error"); } });

            const magnetInput = document.getElementById('magnetInput');
            const magnetPlaceholder = document.getElementById('magnetPlaceholder');
            magnetInput.addEventListener('focus', () => {
                magnetPlaceholder.classList.add('opacity-0');
            });
            magnetInput.addEventListener('blur', () => {
                if (magnetInput.value === '') {
                    magnetPlaceholder.classList.remove('opacity-0');
                }
            });
        }

        document.addEventListener("DOMContentLoaded", initializeApp);
    </script>
</body>
</html>
